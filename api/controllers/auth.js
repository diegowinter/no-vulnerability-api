const pool = require('../../config/db');
const bcrypt = require('bcrypt');
const jwt = require('jsonwebtoken');

module.exports = () => {
  const controller = {}; 

  controller.login = (req, res) => {
    pool.getConnection((err, connection) => {
      if (req.body.username.length <= 20) {
        connection.query(`SELECT * FROM user WHERE username = ?`, [
          req.body.username
        ], function (error, results) {
            connection.release();
            if (error) throw error;
            if(results[0]) {
              const id = results[0].id;
              bcrypt.compare(req.body.password, results[0].passwd, (err, isMatch) => {
                if(err || !isMatch) {
                  res.status(401).json({"message": "Username or password does not match."});
                } else {
                  const token = jwt.sign({ id }, process.env.SECRET, {
                    expiresIn: 3600
                  });
                  if(results[0].is_admin === 1) {
                    res.status(200).json({auth: true, token: token, admin: true});
                  } else {
                    res.status(200).json({auth: true, token: token});
                  }
                }
              })
            } else {
              res.status(401).json({"message": "Username/password does not match."});
            }      
        });
      } else {
        res.status(401).json({"message": "Username/password does not match."});
      }
    });
  }

  return controller;
}