const { nanoid } = require('nanoid');
const bcrypt = require('bcrypt');
const pool = require('../../config/db');

module.exports = () => {
  const controller = {};

  controller.register = (req, res) => {
    const id = nanoid(10);
    const username = req.body.username;
    const email = req.body.email;
    const salt = bcrypt.genSaltSync(10);
    const hash = bcrypt.hashSync(req.body.password, salt);

    pool.getConnection((err, connection) => {
      connection.query(`INSERT INTO user (id, username, email, passwd) VALUES (?, ?, ?, ?)`, [
        id,
        username,
        email,
        hash
      ], function (error, rows) {
          connection.release();
          if (error) throw error;
      });
    });

    res.status(201).json({"message": "Success"});
  }

  return controller;
}